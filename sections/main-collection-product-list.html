<div class="collection-page" style="padding-top: {{section.settings.padding_top}}px; padding-bottom: {{section.settings.padding_bottom}}px;">
  <div class="{{#if section.settings.full_width}}w-full{{else}}max-w-7xl mx-auto{{/if}} px-4 sm:px-6 lg:px-8">
    {{#if collection.products}}
      {{#if (eq section.settings.filter_position "sidebar")}}
        <!-- Sidebar Layout -->
        <div class="flex gap-8">
          <!-- Sidebar Filters -->
          {{#if section.settings.enable_filtering}}
            <aside class="w-64 flex-shrink-0 hidden lg:block">
              <collection-filter-sidebar
                collection-handle="{{collection.handle}}"
                :show-sort="{{#if section.settings.enable_sorting}}true{{else}}false{{/if}}"
              ></collection-filter-sidebar>
            </aside>
          {{/if}}
          
          <!-- Main Content -->
          <div class="flex-1">
            <!-- Mobile Filter Button -->
            {{#if section.settings.enable_filtering}}
              <div class="mb-6 lg:hidden">
                <collection-filter-drawer
                  collection-handle="{{collection.handle}}"
                ></collection-filter-drawer>
              </div>
            {{/if}}
            
            <div class="product-grid grid gap-4" 
                 style="grid-template-columns: repeat({{section.settings.columns_mobile}}, minmax(0, 1fr));"
                 data-products-count="{{collection.products_count}}"
                 data-desktop-columns="{{section.settings.columns_desktop}}"
                 data-mobile-columns="{{section.settings.columns_mobile}}"
                 data-products-per-page="{{section.settings.products_per_page}}">
              {{#each collection.products}}
                <div class="product-card-wrapper" data-product-index="{{@index}}">
                  <product-card
                    product-id="{{this.id}}"
                    variant-id="{{this.variants.[0].id}}"
                    title="{{this.title}}"
                    handle="{{this.handle}}"
                    url="{{this.url}}"
                    vendor="{{this.vendor}}"
                    price="{{this.price}}"
                    compare-at-price="{{this.compare_at_price}}"
                    image="{{image_url this.images.[0] width=800}}"
                    :available="{{#if this.available}}true{{else}}false{{/if}}"
                  ></product-card>
                </div>
              {{/each}}
            </div>
          </div>
        </div>
      {{else}}
        <!-- Drawer Layout (Default) -->
        <!-- Filters and Sorting Bar -->
        {{#if (or section.settings.enable_filtering section.settings.enable_sorting)}}
          <div class="mb-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
              {{#if section.settings.enable_filtering}}
                <collection-filter-drawer
                  collection-handle="{{collection.handle}}"
                ></collection-filter-drawer>
              {{/if}}
            </div>
            
            {{#if section.settings.enable_sorting}}
              <collection-sort
                collection-handle="{{collection.handle}}"
                current-sort="{{#if request.params.sort_by}}{{request.params.sort_by}}{{else}}manual{{/if}}"
              ></collection-sort>
            {{/if}}
          </div>
        {{/if}}
        
        <!-- Products Grid -->
        <div class="product-grid grid gap-4" 
             style="grid-template-columns: repeat({{section.settings.columns_mobile}}, minmax(0, 1fr));"
             data-products-count="{{collection.products_count}}"
             data-desktop-columns="{{section.settings.columns_desktop}}"
             data-mobile-columns="{{section.settings.columns_mobile}}"
             data-products-per-page="{{section.settings.products_per_page}}">
          {{#each collection.products}}
            <div class="product-card-wrapper" data-product-index="{{@index}}">
              <product-card
                product-id="{{this.id}}"
                variant-id="{{this.variants.[0].id}}"
                title="{{this.title}}"
                handle="{{this.handle}}"
                url="{{this.url}}"
                vendor="{{this.vendor}}"
                price="{{this.price}}"
                compare-at-price="{{this.compare_at_price}}"
                image="{{image_url this.images.[0] width=800}}"
                :available="{{#if this.available}}true{{else}}false{{/if}}"
              ></product-card>
            </div>
          {{/each}}
        </div>
      {{/if}}
    {{else}}
      <div class="text-center py-16">
        <!-- Empty State Icon -->
        <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-6">
          <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        
        <!-- No Products Message -->
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No products found</h3>
        <p class="text-gray-500 mb-6 max-w-md mx-auto">
          {{#if request.params.sort_by}}
            Try adjusting your filters or search terms to find what you're looking for.
          {{else}}
            This collection doesn't have any products yet.
          {{/if}}
        </p>
      </div>
    {{/if}}
  </div>
</div>

<style>
  /* Ensure product grid has consistent spacing */
  .product-grid {
    width: 100%;
  }
  
  /* Desktop columns - using data attributes to set grid columns */
  @media (min-width: 768px) {
    .product-grid[data-desktop-columns="2"] {
      grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    }
    .product-grid[data-desktop-columns="3"] {
      grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
    }
    .product-grid[data-desktop-columns="4"] {
      grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
    }
    .product-grid[data-desktop-columns="5"] {
      grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
    }
  }
  
  /* Tablet columns - fixed at 3 for medium screens */
  @media (min-width: 768px) and (max-width: 1023px) {
    .product-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
    }
  }
  
  /* Adjust grid columns when sidebar is present */
  @media (min-width: 1024px) {
    .collection-page .flex-1 .product-grid {
      /* Ensure grid takes full width of the flex-1 container */
      width: 100%;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const productGrids = document.querySelectorAll('.product-grid');
  
  productGrids.forEach(grid => {
    const productsPerPage = parseInt(grid.getAttribute('data-products-per-page')) || 24;
    const allProducts = Array.from(grid.querySelectorAll('.product-card-wrapper'));
    const totalProducts = allProducts.length;
    
    const totalPages = Math.ceil(totalProducts / productsPerPage);
    let currentPage = 1;
    
    // Get current page from URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('page')) {
      currentPage = parseInt(urlParams.get('page')) || 1;
    }
    
    // Create pagination container
    const paginationContainer = document.createElement('nav');
    paginationContainer.className = 'pagination mt-8 flex justify-center items-center gap-2';
    
    function showPage(page) {
      // Hide all products
      allProducts.forEach(product => {
        product.style.display = 'none';
      });
      
      // Calculate start and end indices
      const startIndex = (page - 1) * productsPerPage;
      const endIndex = Math.min(startIndex + productsPerPage, totalProducts);
      
      // Show products for current page
      for (let i = startIndex; i < endIndex; i++) {
        if (allProducts[i]) {
          allProducts[i].style.display = 'block';
        }
      }
      
      // Update pagination controls
      updatePaginationControls(page);
      
      // Update URL
      const newUrl = new URL(window.location.href);
      if (page > 1) {
        newUrl.searchParams.set('page', page);
      } else {
        newUrl.searchParams.delete('page');
      }
      window.history.replaceState({}, '', newUrl.toString());
      
      // Scroll to top of products
      grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function updatePaginationControls(page) {
      // Only update if pagination exists
      if (totalPages <= 1) return;
      
      paginationContainer.innerHTML = '';
      
      // Previous button
      if (page > 1) {
        const prevBtn = createPaginationButton('← Previous', () => showPage(page - 1));
        paginationContainer.appendChild(prevBtn);
      }
      
      // Page numbers
      const pageNumbers = getPageNumbers(page, totalPages);
      pageNumbers.forEach(num => {
        if (num === '...') {
          const dots = document.createElement('span');
          dots.className = 'px-3 py-2 text-sm';
          dots.textContent = '...';
          paginationContainer.appendChild(dots);
        } else {
          const pageBtn = createPaginationButton(num, () => showPage(num), num === page);
          paginationContainer.appendChild(pageBtn);
        }
      });
      
      // Next button
      if (page < totalPages) {
        const nextBtn = createPaginationButton('Next →', () => showPage(page + 1));
        paginationContainer.appendChild(nextBtn);
      }
    }
    
    function createPaginationButton(text, onClick, isActive = false) {
      const btn = document.createElement('button');
      btn.textContent = text;
      btn.onclick = onClick;
      
      if (isActive) {
        btn.className = 'px-3 py-2 text-sm border border-red-600 bg-red-600 text-white rounded';
      } else {
        btn.className = 'px-3 py-2 text-sm border border-gray-300 rounded hover:bg-gray-50 transition-colors';
      }
      
      return btn;
    }
    
    function getPageNumbers(current, total) {
      const delta = 2;
      const range = [];
      const rangeWithDots = [];
      let l;
      
      for (let i = 1; i <= total; i++) {
        if (i === 1 || i === total || (i >= current - delta && i <= current + delta)) {
          range.push(i);
        }
      }
      
      range.forEach((i) => {
        if (l) {
          if (i - l !== 1) {
            rangeWithDots.push('...');
          }
        }
        rangeWithDots.push(i);
        l = i;
      });
      
      return rangeWithDots;
    }
    
    // Only show pagination if there are multiple pages
    if (totalPages > 1) {
      // Insert pagination after the grid
      grid.parentNode.insertBefore(paginationContainer, grid.nextSibling);
    }
    
    // Initialize pagination
    showPage(currentPage);
    
    // Mount Vue components for visible products
    if (window.mountVueComponents) {
      window.mountVueComponents(grid);
    }
  });
  
  // Re-initialize on browser back/forward
  window.addEventListener('popstate', function() {
    location.reload();
  });
});
</script>

{{#schema}}
{
  "name": "t:sections.main-collection-product-list.name",
  "class": "section",
  "settings": [
    {
      "type": "group_header",
      "label": "t:sections.main-collection-product-list.settings.group_header__0.label"
    },
    {
      "type": "switch",
      "id": "full_width",
      "default": false,
      "label": "t:sections.main-collection-product-list.settings.full_width.label",
      "info": "t:sections.main-collection-product-list.settings.full_width.info"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 1,
      "max": 48,
      "step": 1,
      "default": 24,
      "label": "t:sections.main-collection-product-list.settings.products_per_page.label"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4,
      "label": "t:sections.main-collection-product-list.settings.columns_desktop.label"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "options": [
        {
          "value": "1",
          "label": "t:sections.main-collection-product-list.settings.columns_mobile.options__0.label"
        },
        {
          "value": "2",
          "label": "t:sections.main-collection-product-list.settings.columns_mobile.options__1.label"
        }
      ],
      "default": "2",
      "label": "t:sections.main-collection-product-list.settings.columns_mobile.label"
    },
    {
      "type": "group_header",
      "label": "t:sections.main-collection-product-list.settings.group_header__1.label"
    },
    {
      "type": "switch",
      "id": "enable_filtering",
      "default": true,
      "label": "t:sections.main-collection-product-list.settings.enable_filtering.label"
    },
    {
      "type": "select",
      "id": "filter_position",
      "label": "t:sections.main-collection-product-list.settings.filter_position.label",
      "default": "drawer",
      "options": [
        {
          "value": "sidebar",
          "label": "t:sections.main-collection-product-list.settings.filter_position.options__0.label"
        },
        {
          "value": "drawer",
          "label": "t:sections.main-collection-product-list.settings.filter_position.options__1.label"
        }
      ],
      "info": "t:sections.main-collection-product-list.settings.filter_position.info"
    },
    {
      "type": "switch",
      "id": "enable_sorting",
      "default": true,
      "label": "t:sections.main-collection-product-list.settings.enable_sorting.label"
    },
    {
      "type": "group_header",
      "label": "t:sections.main-collection-product-list.settings.group_header__2.label"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 2,
      "unit": "px",
      "label": "t:sections.main-collection-product-list.settings.padding_top.label",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 2,
      "unit": "px",
      "label": "t:sections.main-collection-product-list.settings.padding_bottom.label",
      "default": 80
    }
  ]
}
{{/schema}}